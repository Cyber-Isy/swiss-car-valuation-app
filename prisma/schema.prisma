// Prisma Schema for SwissCarMarket MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Admin user for authentication
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// Car submission from sellers
model Submission {
  id                String   @id @default(cuid())
  status            Status   @default(NEW)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Vehicle info - Basic
  brand             String
  model             String
  variant           String?           // GTI, AMG, M-Sport, etc.
  mileage           Int
  fuelType          FuelType
  condition         Condition

  // Vehicle info - Tier 1 (Critical)
  firstRegistration DateTime?         // Month/Year of first registration (optional for migration)
  transmission      Transmission?     // Optional for migration, required in form
  enginePower       Int?              // in PS (optional for migration)
  bodyType          BodyType?         // Optional for migration, required in form

  // Vehicle info - Tier 2 (Swiss Market)
  driveType         DriveType         @default(FWD)
  mfkDate           DateTime?         // MFK valid until (Month/Year)
  previousOwners    Int?
  accidentFree      Boolean           @default(false)

  // Vehicle info - Tier 3 (Value Modifiers)
  serviceHistory    ServiceHistory?
  exteriorColor     String?
  equipment         String[]          // Array of equipment codes

  // Legacy field (kept for backwards compatibility, derived from firstRegistration)
  year              Int

  // Seller info
  sellerName        String
  sellerEmail       String
  sellerPhone       String
  sellerLocation    String

  // Document
  fahrzeugausweisUrl String

  // AI Valuation (Perplexity)
  aiMarketValue     Int?
  aiPriceMin        Int?
  aiPriceMax        Int?
  aiPurchasePrice   Int?
  aiListingsCount   Int?
  aiSources         String[]  // Array of source names
  aiListings        Json?     // Array of listing objects with url, title, price, etc.
  aiConfidence      String?   // high/medium/low
  aiReasoning       String?
  aiListingsMetadata Json?    // Extraction quality metadata

  // Admin fields
  notes             String?
  finalOfferPrice   Int?
  archived          Boolean   @default(false)
  archivedAt        DateTime?

  // Relations
  vehicleImages     VehicleImage[]
}

// Vehicle photos (multiple per submission)
model VehicleImage {
  id           String     @id @default(cuid())
  url          String
  uploadedAt   DateTime   @default(now())
  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
}

// Enums
enum Status {
  NEW
  CONTACTED
  OFFER_SENT
  ACCEPTED
  COMPLETED
  REJECTED
}

enum FuelType {
  BENZIN
  DIESEL
  ELEKTRO
  HYBRID
  PLUGIN_HYBRID
}

enum Condition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum Transmission {
  MANUAL
  AUTOMATIC
}

enum BodyType {
  LIMOUSINE
  KOMBI
  SUV
  COUPE
  CABRIO
  VAN
  KLEINWAGEN
}

enum DriveType {
  FWD
  RWD
  AWD
}

enum ServiceHistory {
  FULL
  PARTIAL
  NONE
}

// App Settings (Singleton)
model Settings {
  id            String   @id @default("default")
  profitMargin  Float    @default(15.0) // Default 15% profit margin
  updatedAt     DateTime @updatedAt
  updatedBy     String?  // Email of admin who updated
}

// Valuation Cache for cost optimization
model ValuationCache {
  id              String   @id @default(cuid())
  cacheKey        String   // Composite key: brand:model:year:mileageBucket:fuelType

  // Original vehicle parameters
  brand           String
  model           String
  year            Int
  mileage         Int
  fuelType        String

  // Cached valuation results
  marketValue     Int?
  priceMin        Int?
  priceMax        Int?
  purchasePrice   Int?
  listingsCount   Int
  sources         String[]
  confidence      String
  reasoning       String

  createdAt       DateTime @default(now())

  @@index([cacheKey])
  @@index([createdAt])
}
